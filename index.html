<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificación de Certificados - XIII Curso DPI 2026</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f9;text-align:center;padding:40px}
    .box{background:#fff;padding:28px;border-radius:14px;max-width:560px;margin:auto;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    input{padding:12px;width:92%;max-width:420px;margin:14px 0 10px;border:1px solid #cfd6df;border-radius:10px;font-size:16px}
    button{padding:12px 22px;background:#0b3c5d;color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:16px;padding:14px;border-radius:12px;text-align:left;border:1px solid #e6e9ee;background:#fbfbfc}
    .error{border-color:#ffd4d4;background:#fff5f5;color:#b00020}
    .ok{border-color:#cfead6;background:#f3fff6;color:#0b5d2a}
    .row{display:flex;justify-content:space-between;gap:14px;padding:6px 0;border-bottom:1px dashed #e8ecf2}
    .row:last-child{border-bottom:none}
    .k{color:#455;font-weight:700;min-width:190px}
    .v{color:#111;text-align:right;flex:1;word-break:break-word}
    .hint{font-size:12px;color:#667;margin-top:12px}
  </style>
</head>

<body>
  <div class="box">
    <h2>Verificación Oficial de Certificados</h2>
    <p>XIII Curso de Diagnóstico por Imágenes 2026</p>

    <div class="hint">Ingrese su DNI para verificar su certificado.</div>

    <input
      id="dni"
      placeholder="DNI (8 dígitos)"
      inputmode="numeric"
      maxlength="8"
      autocomplete="off"
    />
    <br />
    <button id="btn" onclick="verificar()">Verificar</button>

    <div id="resultado" class="msg" style="display:none;"></div>

    <div class="hint">Sistema oficial de validación digital.</div>
  </div>

<script>
  // ✅ Tu Apps Script Web App (URL /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbzaKAqCZO-kTJufqeQJbP725Wdj4Og-2KeDHyF8sMoE1yivyzNjgHrWnOxPkw7G-Cve/exec";
  const $ = (id) => document.getElementById(id);

  function show(html, type){
    const r = $("resultado");
    r.style.display = "block";
    r.className = "msg " + (type || "");
    r.innerHTML = html;
  }

  function row(k,v){
    return `<div class="row"><div class="k">${k}</div><div class="v">${escapeHtml(String(v ?? ""))}</div></div>`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function formatFecha(val){
    if(!val) return "";
    const d = new Date(val);
    if(!isNaN(d.getTime())) return d.toLocaleDateString("es-PE");
    return String(val);
  }

  // ✅ UX: solo números, max 8
  $("dni").addEventListener("input", () => {
    $("dni").value = $("dni").value.replace(/\D/g, "").slice(0, 8);
  });

  // ✅ Enter SOLO funciona en el input
  $("dni").addEventListener("keydown", (e) => {
    if(e.key === "Enter") verificar();
  });

  async function verificar(){
    const dni = $("dni").value.trim();

    if(!/^\d{8}$/.test(dni)){
      show("El DNI debe tener <b>8 dígitos</b>.", "error");
      return;
    }

    const btn = $("btn");
    btn.disabled = true;
    btn.textContent = "Verificando...";

    try{
      const url = `${API_URL}?dni=${encodeURIComponent(dni)}`;
      const res = await fetch(url, { method:"GET", cache:"no-store" });
      const text = await res.text();

      let data;
      try{ data = JSON.parse(text); } catch(e){
        show("Error: respuesta no válida del servidor.", "error");
        return;
      }

      if(data.error){
        show(`❌ No encontrado.<br><br><b>Detalle:</b> ${escapeHtml(data.error)}`, "error");
        return;
      }

      const html =
        `<b>✅ Certificado encontrado</b><br><br>` +
        row("Código", data["Código"]) +
        row("Apellidos", data["Apellidos completos"]) +
        row("Nombres", data["Nombres completos"]) +
        row("DNI", data["DNI oculto"]) +
        row("Tipo de usuario", data["Tipo de usuario"]) +
        row("Modalidad elegida", data["Modalidad elegida"]) +
        row("Estado", data["Estado"]) +
        row("Tipo de certificado", data["Tipo de Certificado"]) +
        row("Fecha de emisión", formatFecha(data["Fecha de emisión"]));

      const estado = String(data["Estado"] || "").toLowerCase();
      const cls = (estado.includes("valido") || estado.includes("válido")) ? "ok" : "error";
      show(html, cls);

    }catch(err){
      show("Error: no se pudo conectar con el servidor. Intente nuevamente.", "error");
    }finally{
      btn.disabled = false;
      btn.textContent = "Verificar";
    }
  }
</script>
</body>
</html>
