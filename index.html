<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificaci√≥n de Certificados - XIII Curso DPI 2026</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f9;text-align:center;padding:40px}
    .box{background:#fff;padding:28px;border-radius:14px;max-width:620px;margin:auto;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    input{padding:12px;width:92%;max-width:520px;margin:10px 0;border:1px solid #cfd6df;border-radius:10px;font-size:16px}
    button{padding:12px 22px;background:#0b3c5d;color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:16px;margin-top:6px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:16px;padding:14px;border-radius:12px;text-align:left;border:1px solid #e6e9ee;background:#fbfbfc}
    .error{border-color:#ffd4d4;background:#fff5f5;color:#b00020}
    .ok{border-color:#cfead6;background:#f3fff6;color:#0b5d2a}
    .row{display:flex;justify-content:space-between;gap:14px;padding:6px 0;border-bottom:1px dashed #e8ecf2}
    .row:last-child{border-bottom:none}
    .k{color:#455;font-weight:700;min-width:190px}
    .v{color:#111;text-align:right;flex:1;word-break:break-word}
    .hint{font-size:12px;color:#667;margin-top:14px}
    .sep{margin:14px auto;border-top:1px solid #eef1f6;max-width:520px}
  </style>
</head>
<body>
  <div class="box">
    <h2>Verificaci√≥n Oficial de Certificados</h2>
    <p>XIII Curso de Diagn√≥stico por Im√°genes 2026</p>

    <div class="hint">üìå Si tiene el QR, escan√©elo. Si no, verifique por <b>C√≥digo</b> o por <b>DNI</b>.</div>

    <input id="codigo" placeholder="C√≥digo (ej: DPI2026-NOUNMSM-BAS-001)" />
    <div class="sep"></div>
    <input id="dni" placeholder="DNI (8 d√≠gitos)" inputmode="numeric" />

    <br />
    <button id="btn" onclick="verificar()">Verificar</button>

    <div id="resultado" class="msg" style="display:none;"></div>

    <div class="hint">Sistema oficial de validaci√≥n digital.</div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzaKAqCZO-kTJufqeQJbP725Wdj4Og-2KeDHyF8sMoE1yivyzNjgHrWnOxPkw7G-Cve/exec";
  const $ = (id) => document.getElementById(id);

  function show(html, type){
    const r = $("resultado");
    r.style.display = "block";
    r.className = "msg " + (type || "");
    r.innerHTML = html;
  }

  function row(k,v){
    return `<div class="row"><div class="k">${k}</div><div class="v">${escapeHtml(String(v ?? ""))}</div></div>`;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function formatFecha(val){
    if(!val) return "";
    const d = new Date(val);
    if(!isNaN(d.getTime())) return d.toLocaleDateString("es-PE");
    return String(val);
  }

  async function verificar(){
    const codigo = $("codigo").value.trim().toUpperCase();
    const dni = $("dni").value.trim();

    // Validaci√≥n m√≠nima antes de consultar
    if(!codigo && !dni){
      show("Ingrese un <b>C√≥digo</b> o su <b>DNI</b>.", "error");
      return;
    }
    if(dni && !/^\d{8}$/.test(dni)){
      show("El DNI debe tener <b>8 d√≠gitos</b>.", "error");
      return;
    }
    if(codigo && !codigo.startsWith("DPI2026-")){
      show("El c√≥digo debe iniciar con <b>DPI2026-</b>.", "error");
      return;
    }

    const btn = $("btn");
    btn.disabled = true;
    btn.textContent = "Verificando...";

    try{
      const url = codigo
        ? `${API_URL}?codigo=${encodeURIComponent(codigo)}`
        : `${API_URL}?dni=${encodeURIComponent(dni)}`;

      const res = await fetch(url, { method:"GET", cache:"no-store" });
      const text = await res.text();

      let data;
      try{ data = JSON.parse(text); } catch(e){
        show("Error: respuesta no v√°lida del servidor.", "error");
        return;
      }

      if(data.error){
        show(`‚ùå No encontrado.<br><br><b>Detalle:</b> ${escapeHtml(data.error)}`, "error");
        return;
      }

      // Mostrar datos (usa encabezados exactos de tu hoja)
      const html =
        `<b>‚úÖ Certificado v√°lido</b><br><br>` +
        row("C√≥digo", data["C√≥digo"]) +
        row("Apellidos", data["Apellidos completos"]) +
        row("Nombres", data["Nombres completos"]) +
        row("DNI (oculto)", data["DNI oculto"]) +
        row("Modalidad inscripci√≥n", data["Modalidad de Inscripci√≥n"]) +
        row("Modalidad elegida", data["Modalidad elegida"]) +
        row("Estado", data["Estado"]) +
        row("Tipo de certificado", data["Tipo de Certificado"]) +
        row("Fecha de emisi√≥n", formatFecha(data["Fecha de emisi√≥n"]));

      // Si est√° ANULADO, lo marcamos en rojo
      const estado = String(data["Estado"] || "").toLowerCase();
      const cls = (estado.includes("anulado")) ? "error" : "ok";
      show(html, cls);

    }catch(err){
      show("Error: no se pudo conectar con el servidor. Intente nuevamente.", "error");
    }finally{
      btn.disabled = false;
      btn.textContent = "Verificar";
    }
  }

  // Autoverificaci√≥n si viene con ?codigo=...
  (function auto(){
    const params = new URLSearchParams(window.location.search);
    const c = params.get("codigo");
    if(c){
      $("codigo").value = c.toUpperCase().trim();
      verificar();
    }
  })();

  // Enter = verificar
  document.addEventListener("keydown", (e) => {
    if(e.key === "Enter") verificar();
  });
</script>
</body>
</html>
