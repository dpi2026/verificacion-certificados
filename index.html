<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Verificación de Certificados - XIII Curso DPI 2026</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; text-align:center; padding:40px; }
    .box { background:#fff; padding:30px; border-radius:12px; max-width:540px; margin:auto; box-shadow:0 8px 20px rgba(0,0,0,.08); }
    input { padding:12px; width:85%; margin:14px 0; border:1px solid #cfd6dd; border-radius:8px; }
    button { padding:10px 22px; background:#0b3c5d; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { margin-top:18px; font-size:12px; color:#666; }
    .result { margin-top:18px; text-align:left; padding:14px; border-radius:10px; display:none; }
    .ok { background:#e9f7ef; border:1px solid #bfe7cf; }
    .bad { background:#fdecea; border:1px solid #f5c6cb; }
    .row { margin:6px 0; font-size:14px; }
    .label { font-weight:bold; }
    .small { font-size:12px; color:#444; margin-top:6px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Verificación Oficial de Certificados</h2>
    <p>XIII Curso de Diagnóstico por Imágenes 2026</p>
    <p>Avalado por el Colegio Médico del Perú (CMP)</p>

    <input id="codigo" type="text" placeholder="Ingrese código del certificado (ej: DPI2026-NOUNMSM-PRE-001)" />
    <br />
    <button id="btn">Verificar</button>

    <div id="result" class="result"></div>

    <p class="hint">Sistema oficial de validación digital.</p>
  </div>

  <script>
    // TU ENDPOINT (el que me pasaste)
    const API_URL = "https://script.google.com/macros/s/AKfycbxBbYQtlZq917ITNLf-KffefkwTnO7XPCdk-TnVPfwXjbraDWyWZT0rjkvoDbtM0m0L/exec";

    const $codigo = document.getElementById("codigo");
    const $btn = document.getElementById("btn");
    const $result = document.getElementById("result");

    function showResultOk(data) {
      $result.className = "result ok";
      $result.style.display = "block";

      // Ajusta estos campos a lo que devuelve tu JSON
      $result.innerHTML = `
        <div class="row"><span class="label">Estado:</span> ✅ VÁLIDO</div>
        <div class="row"><span class="label">Código:</span> ${escapeHtml(data.codigo || "")}</div>
        <div class="row"><span class="label">Apellidos:</span> ${escapeHtml(data.apellidos || "")}</div>
        <div class="row"><span class="label">Nombres:</span> ${escapeHtml(data.nombres || "")}</div>
        <div class="row"><span class="label">DNI (oculto):</span> ${escapeHtml(data.dni_oculto || "")}</div>
        <div class="row"><span class="label">Modalidad:</span> ${escapeHtml(data.modalidad_inscripcion || "")}</div>
        <div class="row"><span class="label">Certificado:</span> ${escapeHtml(data.tipo_certificado || "")}</div>
        <div class="row"><span class="label">Emisión:</span> ${formatDate(data.fecha_emision)}</div>
        <div class="small">Si hay alguna discrepancia, contáctenos por WhatsApp.</div>
      `;
    }

    function showResultBad(msg) {
      $result.className = "result bad";
      $result.style.display = "block";
      $result.innerHTML = `<div class="row"><span class="label">Resultado:</span> ❌ ${escapeHtml(msg)}</div>`;
    }

    function setLoading(isLoading) {
      $btn.disabled = isLoading;
      $btn.textContent = isLoading ? "Verificando..." : "Verificar";
    }

    async function verificar() {
      const codigo = ($codigo.value || "").trim();
      if (!codigo) return showResultBad("Ingrese un código.");

      $result.style.display = "none";
      setLoading(true);

      try {
        const url = `${API_URL}?codigo=${encodeURIComponent(codigo)}`;

        const resp = await fetch(url, { method: "GET", cache: "no-store" });
        if (!resp.ok) throw new Error("No se pudo conectar al verificador.");

        const json = await resp.json();

        // Esperado: { ok:true, data:{...} } o { ok:false, message:"..." }
        if (json && json.ok && json.data) {
          showResultOk(json.data);
        } else if (json && json.ok === false) {
          showResultBad(json.message || "Código no encontrado.");
        } else {
          // Si tu Apps Script devuelve directo el objeto del certificado (sin wrapper)
          if (json && json.codigo) {
            showResultOk(json);
          } else {
            showResultBad("Código no encontrado.");
          }
        }
      } catch (err) {
        showResultBad("Error al verificar. Revise que el Web App esté publicado como 'Cualquiera' y que el script devuelva JSON.");
        console.error(err);
      } finally {
        setLoading(false);
      }
    }

    // Click botón
    $btn.addEventListener("click", verificar);

    // Enter en el input
    $codigo.addEventListener("keydown", (e) => {
      if (e.key === "Enter") verificar();
    });

    function formatDate(v) {
      if (!v) return "";
      // Si viene como ISO
      try {
        const d = new Date(v);
        if (!isNaN(d.getTime())) {
          return d.toLocaleDateString("es-PE");
        }
      } catch (e) {}
      return String(v);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
